name: UV CI - Cross-platform sync & import checks

on:
  pull_request:
  workflow_dispatch:

jobs:
  uv-verify:
    name: ${{ matrix.os }} (Python 3.11)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup uv (astral)
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python 3.11 via uv
        run: |
          uv python install 3.11

      - name: Install dependencies (uv sync)
        id: uv_sync
        run: |
          set -euxo pipefail
          mkdir -p output
          LOGFILE="output/uv-sync-${{ matrix.os }}.log"
          echo "START: uv sync (${GITHUB_RUN_ID}) on ${RUNNER_OS} at $(date)" > "$LOGFILE"

          # On Linux we implement a retry that installs system deps if uv sync fails
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            attempt=1
            max_attempts=2
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt/$max_attempts: uv sync --all-extras --dev" | tee -a "$LOGFILE"
              if uv sync --all-extras --dev 2>&1 | tee -a "$LOGFILE"; then
                echo "uv sync succeeded" | tee -a "$LOGFILE"
                break
              fi

              echo "uv sync failed on attempt $attempt" | tee -a "$LOGFILE"
              if [ "$attempt" -lt "$max_attempts" ]; then
                echo "Installing build deps and retrying..." | tee -a "$LOGFILE"
                # Best-effort system deps; allow failure but continue to retry
                sudo apt-get update -y || true
                sudo apt-get install -y build-essential gfortran libopenblas-dev || true
                sleep 3
              else
                echo "uv sync failed after $attempt attempts" | tee -a "$LOGFILE"
                cat "$LOGFILE"
                exit 1
              fi
              attempt=$((attempt + 1))
            done

          else
            # macOS / other runners: single attempt
            echo "Running uv sync on macOS" | tee -a "$LOGFILE"
            uv sync --all-extras --dev 2>&1 | tee -a "$LOGFILE"
          fi

          # Save uv.lock if present
          if [ -f uv.lock ]; then
            cp uv.lock output/ || true
          fi
          echo "UV_SYNC_EXIT=0" >> $GITHUB_ENV || true

      - name: Upload uv sync artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uv-sync-artifacts-${{ matrix.os }}
          path: |
            output/uv-sync-${{ matrix.os }}.log
            output/uv.lock

      - name: Import check (quantstats, cvxpy)
        run: |
          python - <<'PY'
import sys
failed = False
for pkg in ('quantstats', 'cvxpy'):
    try:
        m = __import__(pkg)
        v = getattr(m, '__version__', 'unknown')
        print(f"OK: imported {pkg}, version={v}")
    except Exception as e:
        print(f"ERR: import {pkg} failed: {e}")
        failed = True
if failed:
    sys.exit(2)
print('IMPORT_CHECK: OK')
PY

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: uv-verify
    if: ${{ always() }}
    steps:
      - name: Echo summary
        run: |
          echo "UV CI finished. Check artifacts from uv-verify jobs for uv-sync logs and uv.lock files."
