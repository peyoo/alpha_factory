"""
快速开始：2019-2024 因子挖掘实战手册

这个脚本展示如何快速启动多年份因子挖掘任务。
"""

# ============================================================================
# 【快速开始】三步启动挖掘
# ============================================================================

# 步骤 1: 安装依赖
# pip install -r requirements.txt

# 步骤 2: 配置环境变量
# 在 .env 中设置 TUSHARE_TOKEN (需要 Tushare Pro 账户)
# TUSHARE_TOKEN=your_token_here

# 步骤 3: 运行脚本
# python scripts/mine_factors_2019_2024.py \\
#     --start-year 2019 \\
#     --end-year 2024 \\
#     --n-gen 20 \\
#     --n-pop 500


# ============================================================================
# 【常见命令】
# ============================================================================

"""
1. 挖掘全 2019-2024 年数据 (完整模式，约 48-72 小时)
   python scripts/mine_factors_2019_2024.py \\
       --start-year 2019 \\
       --end-year 2024 \\
       --n-gen 30 \\
       --n-pop 500

2. 快速测试单年份 (2024 年，约 1-2 小时)
   python scripts/mine_factors_2019_2024.py \\
       --start-year 2024 \\
       --end-year 2024 \\
       --n-gen 10 \\
       --n-pop 300

3. 轻量级挖掘 (快速实验，约 30 分钟)
   python scripts/mine_factors_2019_2024.py \\
       --start-year 2023 \\
       --end-year 2024 \\
       --n-gen 5 \\
       --n-pop 150 \\
       --batch-size 30

4. 覆盖已有缓存重新挖掘
   python scripts/mine_factors_2019_2024.py \\
       --start-year 2024 \\
       --end-year 2024 \\
       --n-gen 20 \\
       --overwrite-data

5. 自定义目标标签挖掘
   python scripts/mine_factors_2019_2024.py \\
       --start-year 2024 \\
       --end-year 2024 \\
       --label target_5d_return \\
       --n-gen 15
"""


# ============================================================================
# 【核心参数说明】
# ============================================================================

"""
--start-year (int, 默认 2019)
  - 挖掘的起始年份
  - 建议范围：2015-2024
  - 越早的年份数据越稀缺，挖掘效果可能较差

--end-year (int, 默认 2024)
  - 挖掘的结束年份
  - 必须 >= start_year
  - 如果只需要单年份，设置 start_year == end_year

--n-gen (int, 默认 20)
  - 每个年份的进化代数
  - 更多代数 = 更好收敛，但耗时更长
  - 参考值：
    * 轻量实验：5-10
    * 常规挖掘：15-25
    * 深度优化：30-50

--n-pop (int, 默认 500)
  - 初始种群大小
  - 更大种群 = 更好的多样性，但耗时更长
  - 参考值：
    * 轻量实验：100-200
    * 常规挖掘：300-500
    * 深度优化：500-1000

--batch-size (int, 默认 50)
  - 批处理大小（单次计算多少个表达式）
  - 影响内存使用和并行效率
  - 参考值：
    * 内存限制 (< 8GB)：20-30
    * 常规 (8-16GB)：40-60
    * 高端 (> 16GB)：80-100

--label (str, 默认 "RETURN_OO_1")
  - 目标标签列名，必须在数据中存在
  - 常见标签：
    * RETURN_OO_1: 开盘-开盘 1 天收益率
    * target_1d_return: 1 天目标收益
    * target_5d_return: 5 天目标收益
  - 查看可用标签：python scripts/inspect_data_schema.py --year 2024

--overwrite-data (flag, 默认 False)
  - 是否覆盖已有的缓存数据
  - 设置后会重新生成所有数据
  - 用于修复数据问题或更新数据源

--save-summary (flag, 默认 True)
  - 是否保存挖掘摘要到文件
  - 摘要会保存到 output/reports/mining_summary_*.txt
"""


# ============================================================================
# 【输出结构】
# ============================================================================

"""
挖掘完成后，结果存储在 output/gp/ 目录：

output/gp/
├── 2019/
│   ├── data_cache/
│   │   └── labeled_RETURN_OO_1.parquet    # 标签数据缓存
│   ├── fitness_cache.pkl                  # 适应度结果缓存
│   ├── exprs_000.pkl, exprs_001.pkl ...   # 每代种群备份
│   ├── best_hof.pkl                       # 名人堂 (最优因子)
│   └── 2019_result.pkl                    # 完整结果
├── 2020/
│   └── ...
└── 2024/
    └── ...

reports/
└── mining_summary_20260123_120000.txt     # 挖掘摘要报告
"""


# ============================================================================
# 【性能参考】
# ============================================================================

"""
典型运行时间 (单台 CPU，4 核):

配置                          耗时
=================================================================
单年份, n_gen=10, n_pop=200   ~ 30 分钟
单年份, n_gen=20, n_pop=300   ~ 1-1.5 小时
单年份, n_gen=30, n_pop=500   ~ 2-3 小时
2 年份, n_gen=20, n_pop=300   ~ 2-3 小时
3 年份, n_gen=20, n_pop=300   ~ 3-4 小时
全 6 年份, n_gen=20, n_pop=300 ~ 6-8 小时

说明：
- 实际耗时取决于：数据大小、CPU 核数、数据预处理复杂度
- 首次运行包括数据加载，后续缓存会加速
- 如需加速，可考虑：
  1. 减少 n_gen 或 n_pop
  2. 增加 batch_size (需要更多内存)
  3. 使用 GPU (目前不支持，可以贡献 PR)
"""


# ============================================================================
# 【中断恢复】
# ============================================================================

"""
如果挖掘过程被中断（如网络问题、电源故障），可以安全恢复：

1. 挖掘会自动保存：
   - 每代种群到 exprs_XXX.pkl
   - 适应度评估结果到 fitness_cache.pkl
   - 最终结果到 year_result.pkl

2. 恢复方式（自动）：
   再次运行相同命令，脚本会：
   - 检查是否已存在缓存
   - 加载已计算的适应度，跳过重复计算
   - 继续从上次中断的地方执行

3. 如需完全重新运行：
   加上 --overwrite-data 标志
"""


# ============================================================================
# 【故障排查】
# ============================================================================

"""
常见问题与解决方案：

Q1: "数据文件不存在" 错误
A1: 需要先同步数据
    python scripts/sync_data_2019_2024.py

Q2: "TUSHARE_TOKEN 未设置" 错误
A2: 检查 .env 文件，确保设置了 TUSHARE_TOKEN=your_token

Q3: 内存溢出 (OOM)
A3: 减少参数：
    --n-pop 200 --batch-size 30

Q4: 表达式计算失败
A4: 检查目标标签是否存在于数据中
    python scripts/inspect_data_schema.py --year 2024

Q5: 进化缓慢/不收敛
A5: 增加进化代数或调整超参数
    --n-gen 30 --n-pop 500
"""


# ============================================================================
# 【下一步】
# ============================================================================

"""
挖掘完成后：

1. 查看名人堂因子
   python scripts/inspect_halloffame.py --year 2024

2. 评估因子效果
   python scripts/evaluate_factors.py --year 2024 --method rankic

3. 多因子合成与回测
   python scripts/backtest_factors.py \\
       --factors output/gp/2024/best_hof.pkl \\
       --start-date 20230101 \\
       --end-date 20241231

4. 生成因子报告
   python scripts/generate_report.py --hof output/gp/2024/best_hof.pkl
"""


# ============================================================================
# 【示例：完整工作流】
# ============================================================================

if __name__ == "__main__":
    import subprocess
    import sys

    print("""
    ╔══════════════════════════════════════════════════════════════╗
    ║                  Alpha-Factory 挖掘完整工作流                  ║
    ╚══════════════════════════════════════════════════════════════╝
    """)

    # 第 1 步：数据同步 (可选，如已有数据可跳过)
    print("\n[1/3] 同步数据 (可选)...")
    print("      python scripts/sync_data_2019_2024.py")
    print("      (首次运行需要 30-60 分钟)")

    # 第 2 步：因子挖掘
    print("\n[2/3] 启动因子挖掘...")
    print("      python scripts/mine_factors_2019_2024.py \\")
    print("          --start-year 2024 \\")
    print("          --end-year 2024 \\")
    print("          --n-gen 20 \\")
    print("          --n-pop 500")

    # 第 3 步：效果评估
    print("\n[3/3] 评估因子效果...")
    print("      python scripts/evaluate_factors.py --year 2024")

    print("\n" + "=" * 60)
    print("更多帮助：python scripts/mine_factors_2019_2024.py --help")
    print("=" * 60)
